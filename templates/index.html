<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Real-Time Currency Rates</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f4f4f9;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      h1 {
        margin-bottom: 20px;
        color: #2c3e50;
      }
      .chart-container {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: center;
        align-items: flex-start;
        gap: 50px;
      }
      .chart {
        width: 45%;
        height: 70vh;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .rate-display {
        margin-top: 10px;
        text-align: center;
        font-size: 1.2em;
        color: #2c3e50;
      }
      .rates-container {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: center;
        align-items: flex-start;
        gap: 50px;
      }
      .rate {
        width: 45%;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Real-Time Currency Rates</h1>
    <div class="chart-container">
      <div id="chart1" class="chart"></div>
      <div id="chart2" class="chart"></div>
    </div>
    <div class="rates-container">
      <div class="rate">
        <p class="rate-display">
          Current USD to EUR: <strong id="usdToEurRate">Loading...</strong>
        </p>
      </div>
      <div class="rate">
        <p class="rate-display">
          Current BTC to USD: <strong id="btcToUsdRate">Loading...</strong>
        </p>
      </div>
    </div>
    <script>
      var times = {{.Times}};
      var usdToEur = {{.USDToEUR}};
      var btcToUsd = {{.BTCToUSD}};

      // Convert times to Date objects
      var timesFormatted = times.map(function(t) {
          return new Date(t);
      });

      // Function to create charts
      function createCharts() {
          var now = new Date();
          var thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);

          // USD to EUR Chart
          var trace1 = {
              x: timesFormatted,
              y: usdToEur.map(Number),
              mode: 'lines+markers',
              name: 'USD to EUR',
              line: {color: '#007BFF', width: 3},
              marker: {size: 6, color: '#007BFF'},
              hovertemplate: '%{x|%H:%M:%S}<br>USD to EUR: %{y}<extra></extra>'
          };

          var layout1 = {
              title: 'USD to EUR Exchange Rate',
              xaxis: {
                  title: 'Time',
                  type: 'date',
                  range: [thirtyMinutesAgo, now],
                  showgrid: true,
                  zeroline: false,
                  tickformat: "%H:%M:%S"
              },
              yaxis: {
                  title: 'Exchange Rate',
                  autorange: true,
                  showline: false,
                  side: 'left',
                  // Adjust range as needed or remove to let Plotly autoscale
              },
              template: 'plotly_white',
              margin: {l: 60, r: 60, t: 50, b: 50},
              showlegend: true,
              legend: {
                  x: 0.5,
                  y: -0.2,
                  xanchor: 'center',
                  orientation: 'h'
              }
          };

          Plotly.newPlot('chart1', [trace1], layout1);

          // BTC to USD Chart
          var trace2 = {
              x: timesFormatted,
              y: btcToUsd.map(Number),
              mode: 'lines+markers',
              name: 'BTC to USD',
              line: {color: '#FF5733', width: 3},
              marker: {size: 6, color: '#FF5733'},
              hovertemplate: '%{x|%H:%M:%S}<br>BTC to USD: %{y}<extra></extra>'
          };

          var layout2 = {
              title: 'BTC to USD Exchange Rate',
              xaxis: {
                  title: 'Time',
                  type: 'date',
                  range: [thirtyMinutesAgo, now],
                  showgrid: true,
                  zeroline: false,
                  tickformat: "%H:%M:%S"
              },
              yaxis: {
                  title: 'Exchange Rate',
                  autorange: true,
                  showline: false,
                  side: 'left',
                  // Adjust range as needed or remove to let Plotly autoscale
              },
              template: 'plotly_white',
              margin: {l: 70, r: 70, t: 50, b: 50},
              showlegend: true,
              legend: {
                  x: 0.5,
                  y: -0.2,
                  xanchor: 'center',
                  orientation: 'h'
              }
          };

          Plotly.newPlot('chart2', [trace2], layout2);
      }

      // Function to fetch new data and update the page
      async function fetchDataAndUpdate() {
          try {
              const response = await fetch('/data');
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              const dataResponse = await response.json();

              // Update data variables
              times = dataResponse.times;
              usdToEur = dataResponse.usdToEur;
              btcToUsd = dataResponse.btcToUsd;

              // Update formatted times
              timesFormatted = times.map(function(t) {
                  return new Date(t);
              });

              // Update displayed rates without ограничений на количество знаков
              document.getElementById('usdToEurRate').textContent = dataResponse.currentUSDtoEUR;
              document.getElementById('btcToUsdRate').textContent = dataResponse.currentBTCtoUSD;

              // Recreate charts
              createCharts();
          } catch (e) {
              console.error("Error fetching and updating data:", e);
          }
      }

      // Initial data fetch and chart creation
      fetchDataAndUpdate();

      // Update data every 10 seconds
      setInterval(fetchDataAndUpdate, 10000);
    </script>
  </body>
</html>
